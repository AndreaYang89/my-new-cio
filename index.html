<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaLog V1.4 - æ‚¨çš„èµ„äº§é©¾é©¶èˆ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        accent: '#3b82f6',
                        danger: '#ef4444', 
                        success: '#22c55e',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark text-slate-200 font-sans antialiased min-h-screen pb-20">

    <nav class="sticky top-0 z-40 bg-dark/90 backdrop-blur-md border-b border-slate-800 px-4 py-3 flex justify-between items-center shadow-lg">
        <h1 class="font-bold text-xl tracking-tight text-white flex items-center">
            <i class="fa-solid fa-chart-pie text-accent mr-2"></i> AlphaLog <span class="text-[10px] ml-2 bg-slate-800 px-2 py-0.5 rounded text-slate-400">V1.4 Live</span>
        </h1>
        <div class="flex items-center bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700">
            <span class="text-xs text-slate-400 mr-2">USD/CNY</span>
            <input type="number" id="exchangeRate" class="w-12 bg-transparent text-right font-bold text-white text-sm focus:outline-none focus:text-accent transition" onchange="updateDashboard(true)">
        </div>
    </nav>

    <div class="max-w-5xl mx-auto p-4 space-y-6">

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            
            <div class="md:col-span-7 flex flex-col gap-4">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl border border-slate-700 shadow-2xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-10 transition">
                        <i class="fa-solid fa-wallet text-9xl"></i>
                    </div>
                    <p class="text-slate-400 text-sm font-medium uppercase tracking-wider flex items-center">
                        <i class="fa-solid fa-calculator mr-2"></i> å‡€èµ„äº§æ€»é¢ (RMB)
                    </p>
                    <h2 class="text-5xl md:text-6xl font-bold text-white mt-4 font-mono tracking-tighter" id="totalAssetDisplay">---</h2>
                    <p class="text-xs text-slate-500 mt-4">
                        * è‡ªåŠ¨åˆè®¡ï¼šè¯åˆ¸æŒä»“ + ç¾å…ƒç°é‡‘(æŠ˜ç®—) + äººæ°‘å¸å­˜æ¬¾
                    </p>
                </div>

                <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700 border-dashed hover:border-slate-500 transition">
                    <div class="flex justify-between items-center">
                        <label class="text-sm text-slate-300 flex items-center">
                            <i class="fa-solid fa-building-columns text-slate-500 mr-2"></i> é“¶è¡Œå­˜æ¬¾/ç†è´¢ (è¡¥å…¨å·®é¢)
                        </label>
                        <div class="flex items-center">
                            <span class="text-slate-500 mr-2">Â¥</span>
                            <input type="number" id="rmbCashInput" class="bg-slate-900 border border-slate-600 rounded px-2 py-1 text-right text-white font-mono w-32 focus:border-accent focus:outline-none" placeholder="0" onchange="updateDashboard(true)">
                        </div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-5 bg-slate-800 p-4 rounded-3xl border border-slate-700 shadow-xl flex flex-col items-center justify-center relative min-h-[300px]">
                <h3 class="absolute top-4 left-4 text-xs font-bold text-slate-500 uppercase">èµ„äº§åˆ†å¸ƒ</h3>
                <div class="w-64 h-64 relative">
                    <canvas id="assetChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                        <span class="text-xs text-slate-500">USD Ratio</span>
                        <span class="text-xl font-bold text-white" id="usdRatioText">--%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-slate-900/50 rounded-3xl p-1">
            <div class="flex space-x-1 p-1 mb-2">
                <button onclick="switchTab('all')" class="tab-btn active flex-1 py-2 rounded-xl text-sm font-bold transition text-center" data-tab="all">å…¨éƒ¨</button>
                <button onclick="switchTab('cn')" class="tab-btn flex-1 py-2 rounded-xl text-sm font-bold transition text-center" data-tab="cn">ğŸ‡¨ğŸ‡³ Aè‚¡</button>
                <button onclick="switchTab('global')" class="tab-btn flex-1 py-2 rounded-xl text-sm font-bold transition text-center" data-tab="global">ğŸŒ æµ·å¤–</button>
                <button onclick="switchTab('cash')" class="tab-btn flex-1 py-2 rounded-xl text-sm font-bold transition text-center" data-tab="cash">ğŸ’µ ç°é‡‘</button>
            </div>

            <div id="portfolioList" class="space-y-3 px-2 pb-2">
                </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. æ•°æ®åˆå§‹åŒ– (åŸºäºæ‚¨çš„ CSV å‡†ç¡®æ•°æ®)
        // ==========================================
        
        // é»˜è®¤é…ç½®
        const defaultConfig = {
            exchangeRate: 7.29,
            rmbCash: 220000, // é¢„ä¼°ç¼ºå£ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹
            usdCash: 18000   // å›ºå®šçš„ç¾å…ƒå‚¨å¤‡
        };

        // ä» LocalStorage è¯»å–ç”¨æˆ·ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤
        const savedConfig = JSON.parse(localStorage.getItem('alphaLogConfig')) || defaultConfig;

        // è¯åˆ¸æŒä»“ (æ¥è‡ª Excel è§£æï¼Œç²¾ç¡®åˆ°å°æ•°ç‚¹)
        // è‡ªåŠ¨æ‰“æ ‡ï¼šcategory (cn/global)
        const securities = [
            {code: '007339', name: 'æ˜“æ–¹è¾¾æ²ªæ·±300', value: 44016.20, pl: 0.19, category: 'cn'},
            {code: '004742', name: 'æ˜“æ–¹è¾¾æ·±è¯100', value: 49186.49, pl: 0.84, category: 'cn'},
            {code: '560980', name: 'å…‰ä¼é¾™å¤´ETF', value: 16445.80, pl: 2.72, category: 'cn'},
            {code: '159781', name: 'ç§‘åˆ›åˆ›ä¸š50', value: 14905.80, pl: 3.64, category: 'cn'},
            {code: '512400', name: 'æœ‰è‰²ETF', value: 14406.00, pl: 20.02, category: 'cn'},
            {code: '020712', name: 'æ—¥ç»225è”æ¥', value: 9801.22, pl: 5.35, category: 'global'},
            {code: '008764', name: 'å¤©å¼˜è¶Šå—å¸‚åœº', value: 9073.04, pl: -7.50, category: 'global'},
            {code: '003984', name: 'å˜‰å®æ–°èƒ½æº', value: 8380.55, pl: -1.64, category: 'cn'},
            {code: '009505', name: 'å¯Œå›½ä¸Šæµ·é‡‘', value: 8324.46, pl: 15.24, category: 'cn'}, // é»„é‡‘å½’ä¸ºCNYå®šä»·èµ„äº§
            {code: '588290', name: 'èŠ¯ç‰‡ç§‘åˆ›ETF', value: 8003.10, pl: -2.38, category: 'cn'},
            {code: '025209', name: 'æ°¸èµ¢åŠå¯¼ä½“', value: 8067.01, pl: -5.10, category: 'cn'},
            {code: '017436', name: 'åå®çº³æ–¯è¾¾å…‹', value: 6059.19, pl: -3.30, category: 'global'},
            {code: '159915', name: 'åˆ›ä¸šæ¿ETF', value: 5202.00, pl: 6.32, category: 'cn'},
            {code: '007455', name: 'å¯Œå›½è“ç­¹QDII', value: 4806.39, pl: 2.33, category: 'global'},
            {code: '512820', name: 'é“¶è¡Œè‚¡åŸº', value: 4260.00, pl: -1.44, category: 'cn'},
            {code: '017144', name: 'æµ·å¤–æ–°èƒ½æº', value: 3552.41, pl: 28.40, category: 'global'},
            {code: '515880', name: 'é€šä¿¡ETF', value: 2826.00, pl: 91.70, category: 'cn'},
            {code: '513200', name: 'æ¸¯è‚¡åŒ»è¯ETF', value: 2558.40, pl: -37.99, category: 'global'}, // ç—›ç‚¹
            {code: '022365', name: 'æ°¸èµ¢ç§‘æŠ€æ™ºé€‰', value: 1627.04, pl: 8.47, category: 'cn'},
            {code: '513880', name: 'æ—¥ç»225ETF', value: 14711.70, pl: -6.64, category: 'global'}
        ];

        let chartInstance = null;
        let currentTab = 'all';

        // ==========================================
        // 2. æ ¸å¿ƒè®¡ç®—ä¸æ¸²æŸ“é€»è¾‘
        // ==========================================
        function updateDashboard(save = false) {
            // è·å–è¾“å…¥å€¼
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 7.28;
            const rmbCash = parseFloat(document.getElementById('rmbCashInput').value) || 0;
            const usdCash = savedConfig.usdCash;

            // 1. è®¡ç®—å„æ¿å—æ€»é¢
            let sumSecuritiesCN = 0;
            let sumSecuritiesGlobal = 0;

            securities.forEach(item => {
                if (item.category === 'cn') sumSecuritiesCN += item.value;
                if (item.category === 'global') sumSecuritiesGlobal += item.value;
            });

            // æ€»èµ„äº§ = è¯åˆ¸(CN) + è¯åˆ¸(Global) + RMBç°é‡‘ + (USDç°é‡‘ * æ±‡ç‡)
            const usdCashInRmb = usdCash * rate;
            const totalAsset = sumSecuritiesCN + sumSecuritiesGlobal + rmbCash + usdCashInRmb;

            // 2. æ›´æ–° DOM
            document.getElementById('totalAssetDisplay').innerText = "Â¥ " + totalAsset.toLocaleString('zh-CN', { maximumFractionDigits: 0 });
            
            // 3. æ›´æ–°å›¾è¡¨ (ç”œç”œåœˆ)
            updateChart(sumSecuritiesCN + rmbCash, sumSecuritiesGlobal, usdCashInRmb);

            // 4. ä¿å­˜é…ç½®
            if (save) {
                localStorage.setItem('alphaLogConfig', JSON.stringify({
                    exchangeRate: rate,
                    rmbCash: rmbCash,
                    usdCash: usdCash
                }));
            }

            // 5. æ¸²æŸ“åˆ—è¡¨
            renderList(rate);
        }

        function updateChart(cnVal, globalVal, usdVal) {
            const ctx = document.getElementById('assetChart').getContext('2d');
            
            const data = {
                labels: ['Aè‚¡/CNY', 'æµ·å¤–æƒç›Š', 'ç¾å…ƒç°é‡‘'],
                datasets: [{
                    data: [cnVal, globalVal, usdVal],
                    backgroundColor: ['#3b82f6', '#a855f7', '#10b981'], // Blue, Purple, Green
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            };

            // è®¡ç®—ç¾å…ƒå æ¯”
            const total = cnVal + globalVal + usdVal;
            const usdRatio = ((usdVal / total) * 100).toFixed(1);
            document.getElementById('usdRatioText').innerText = usdRatio + "%";
            document.getElementById('usdRatioText').className = "text-xl font-bold " + (usdRatio > 20 ? "text-emerald-400" : "text-white");

            if (chartInstance) {
                chartInstance.data = data;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        cutout: '70%',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#94a3b8', boxWidth: 10, padding: 20 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        label += 'Â¥' + context.raw.toLocaleString();
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderList(rate) {
            const container = document.getElementById('portfolioList');
            container.innerHTML = '';

            // æ„é€ å…¨é‡åˆ—è¡¨ (æŠŠç°é‡‘ä¹Ÿå¡è¿›å»æ–¹ä¾¿å±•ç¤º)
            let allItems = [...securities];
            
            // åªæœ‰å½“ Tab æ˜¯ Cash æˆ– All æ—¶æ‰æ˜¾ç¤ºç°é‡‘
            const usdCashItem = { name: "ç¾å…ƒå‚¨å¤‡ (è´­è½¦)", code: "USD", value: savedConfig.usdCash, pl: 0, category: 'cash', isCash: true };
            const rmbCashItem = { name: "é“¶è¡Œå­˜æ¬¾/ç†è´¢", code: "CNY", value: parseFloat(document.getElementById('rmbCashInput').value)||0, pl: 0, category: 'cash', isCash: true };
            
            allItems.push(usdCashItem);
            allItems.push(rmbCashItem);

            // è¿‡æ»¤
            if (currentTab !== 'all') {
                allItems = allItems.filter(i => i.category === currentTab);
            }

            // æ’åº (é‡‘é¢ä»å¤§åˆ°å°)
            allItems.sort((a, b) => b.value - a.value);

            allItems.forEach(item => {
                if(item.value === 0 && !item.isCash) return; // éšè—0èµ„äº§

                let displayVal = item.value;
                let symbol = 'Â¥';
                
                // ç‰¹æ®Šå¤„ç†ç¾å…ƒå±•ç¤º
                if (item.code === 'USD') {
                    symbol = '$'; // æ˜¾ç¤ºåŸå¸
                    // æ’åºç”¨RMBç®—
                }

                const plClass = item.pl > 0 ? 'text-danger' : (item.pl < 0 ? 'text-success' : 'text-slate-500');
                const plBg = item.pl > 0 ? 'bg-danger/10' : (item.pl < 0 ? 'bg-success/10' : 'bg-slate-800');
                const plSign = item.pl > 0 ? '+' : '';
                
                let iconClass = 'fa-chart-line';
                if(item.category === 'cash') iconClass = 'fa-sack-dollar';
                if(item.category === 'global') iconClass = 'fa-globe';

                const html = `
                <div class="bg-card p-4 rounded-2xl border border-slate-800 flex justify-between items-center group hover:bg-slate-800 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${plBg} flex items-center justify-center text-lg">
                            <i class="fa-solid ${iconClass} ${plClass}"></i>
                        </div>
                        <div>
                            <div class="font-bold text-white text-sm">${item.name}</div>
                            <div class="text-[10px] text-slate-500 bg-slate-900 px-1.5 py-0.5 rounded inline-block font-mono mt-1">${item.code}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-white font-mono">${symbol} ${item.value.toLocaleString()}</div>
                        ${!item.isCash ? `<div class="text-xs ${plClass} font-bold mt-1">${plSign}${item.pl}%</div>` : ''}
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if(btn.dataset.tab === tab) {
                    btn.className = 'tab-btn active flex-1 py-2 rounded-xl text-sm font-bold transition text-center bg-accent text-white shadow-lg shadow-blue-900/50';
                } else {
                    btn.className = 'tab-btn flex-1 py-2 rounded-xl text-sm font-bold transition text-center text-slate-400 hover:text-white hover:bg-slate-800';
                }
            });
            renderList(parseFloat(document.getElementById('exchangeRate').value));
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            document.getElementById('exchangeRate').value = savedConfig.exchangeRate;
            document.getElementById('rmbCashInput').value = savedConfig.rmbCash;
            updateDashboard(false);
            switchTab('all');
        }

    </script>
</body>
</html>
